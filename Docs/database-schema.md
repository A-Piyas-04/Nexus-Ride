# NexusRide Database Schema

This document describes the current database schema as defined by the SQLModel models in the backend. It covers tables, columns (with key properties), and the relationships between them.

---

## Overview of Tables

- `user`
- `role`
- `userrole`
- `subscription`

Each of these tables is created from the corresponding SQLModel class in the `app.models` package.

---

## `user` Table

**Source model**: `app/models/user.py:5-10`  
**SQLModel class**: `User(SQLModel, table=True)`

**Logical purpose**: Stores core identity and authentication information for each platform user.

### Columns

| Column         | Type   | Database Type | Constraints / Properties                                   |
|----------------|--------|---------------|------------------------------------------------------------|
| `id`           | UUID   | `uuid`        | Primary key, non-null, generated by `uuid4` on insert     |
| `email`        | str\*  | `varchar`     | Nullable, unique, used for login and identity             |
| `password_hash`| str    | `varchar`     | Non-null, stores bcrypt password hash (never plain text)  |
| `full_name`    | str    | `varchar`     | Non-null, user’s display name                             |
| `user_type`    | str    | `varchar`     | Non-null, e.g. `"STAFF"` or `"DRIVER"`                    |

\* In the model: `Optional[str] = Field(default=None, unique=True)`, which results in a nullable unique column. The application normalizes emails to lowercase before storage and lookup.

### Key Behaviors

- New IDs are generated automatically using `uuid4`.
- Emails are unique across all users, but may be null (e.g., for system users if ever introduced).
- Password hashes are created and verified using bcrypt via `app/utils/hashing.py`.

---

## `role` Table

**Source model**: `app/models/role.py:5-7`  
**SQLModel class**: `Role(SQLModel, table=True)`

**Logical purpose**: Represents high-level roles (permissions groupings) that can be assigned to users.

### Columns

| Column | Type | Database Type | Constraints / Properties                      |
|--------|------|---------------|-----------------------------------------------|
| `id`   | int  | `integer`     | Primary key, auto-incrementing, non-null      |
| `name` | str  | `varchar`     | Non-null, unique (e.g., `"ADMIN"`, `"STAFF"`) |

### Key Behaviors

- Each role has a unique name.
- Roles are linked to users through the `userrole` join table (many-to-many).

---

## `userrole` Table

**Source model**: `app/models/role.py:9-11`  
**SQLModel class**: `UserRole(SQLModel, table=True)`

**Logical purpose**: Join table mapping users to roles, enabling a many-to-many relationship between `user` and `role`.

### Columns

| Column   | Type | Database Type | Constraints / Properties                                      |
|----------|------|---------------|---------------------------------------------------------------|
| `user_id`| UUID | `uuid`        | Part of composite primary key, foreign key → `user.id`       |
| `role_id`| int  | `integer`     | Part of composite primary key, foreign key → `role.id`       |

### Composite Primary Key

- Both `user_id` and `role_id` are marked as `primary_key=True`.
- This enforces that each `(user_id, role_id)` pair is unique:
  - A given user cannot be assigned the same role more than once.

### Foreign Keys and Relationships

- `userrole.user_id` → `user.id`
- `userrole.role_id` → `role.id`

Together, these define a **many-to-many** relationship:

- One user can have many roles.
- One role can be assigned to many users.

---

## `subscription` Table

**Source model**: `app/models/subscription.py:6-11`  
**SQLModel class**: `Subscription(SQLModel, table=True)`

**Logical purpose**: Tracks subscription or plan status for users over time.

### Columns

| Column      | Type   | Database Type | Constraints / Properties                                  |
|-------------|--------|---------------|-----------------------------------------------------------|
| `id`        | int    | `integer`     | Primary key, auto-incrementing, non-null                  |
| `user_id`   | UUID   | `uuid`        | Non-null, foreign key → `user.id`                         |
| `status`    | str    | `varchar`     | Non-null, e.g. `"PENDING"`, `"ACTIVE"`, `"EXPIRED"`       |
| `start_date`| date\* | `date`        | Nullable, subscription start date                         |
| `end_date`  | date\* | `date`        | Nullable, subscription end date                           |

\* `start_date` and `end_date` are defined as `Optional[date]`, so they are nullable in the database.

### Foreign Keys and Relationships

- `subscription.user_id` → `user.id`
- Relationship type: **one-to-many** from `user` to `subscription`:
  - One user can have many subscriptions over time.
  - Each subscription belongs to exactly one user.

---

## Relationship Summary

This section summarizes how the tables relate to each other at a high level.

### User ↔ Role (Many-to-Many)

- Implemented via the `userrole` join table.
- A user can hold multiple roles; each role can be assigned to multiple users.

**Path**:

- `user.id` ↔ `userrole.user_id`  
- `role.id` ↔ `userrole.role_id`

### User ↔ Subscription (One-to-Many)

- Each subscription is associated with a single user through `subscription.user_id`.
- A user may have multiple subscription records over time (e.g., renewals, plan changes).

**Path**:

- `user.id` ↔ `subscription.user_id`

---

## Table Creation and Lifecycle

- All tables (`user`, `role`, `userrole`, `subscription`) are created automatically at application startup.
- The creation is triggered by `SQLModel.metadata.create_all(engine)` in the FastAPI lifespan handler (`app/main.py`), ensuring:
  - Tables exist before any request is processed.
  - Foreign key constraints are created consistently with the model definitions.

